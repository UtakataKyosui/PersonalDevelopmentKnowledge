
# 🌙 PhantoMoon 機能要件定義一覧（v0.1 設計段階）

Claude Code セッションの Git Worktree 管理・TUI 操作・GitHub連携・コスト分析などを統合的に提供する CLI ツール。

---

## ✅ 1. TUIベースのセッション一覧管理

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 機能名       | セッション管理UI（ratatui）                                          |
| ユースケース | 作成済Worktreeの状態を表形式で一覧表示し、操作（起動/削除など）可能にする |
| 入力         | `.phantommoon/sessions/*.json` 情報                                 |
| 出力         | TUIテーブル表示、選択による操作遷移                                 |
| 操作         | ↑↓で移動、Enter: シェル起動、`d`: 削除、`p`: PR作成、`i`: Issue紐付け |
| 成功条件     | Worktree状態を即時に反映し、ユーザ操作がフィードバックされること       |

---

## ✅ 2. Worktree + Claude Code セッション作成

| 項目         | 内容                                                          |
|--------------|---------------------------------------------------------------|
| 機能名       | セッション作成                                                |
| ユースケース | プロジェクトに対して新しいセッション（Worktree）を作成       |
| 入力         | セッション名、ベースブランチ、Issue番号（任意）              |
| 出力         | `git worktree add`、`.phantommoon/sessions/{name}.json` 生成 |
| 成功条件     | Worktreeが正しく作成され、tmuxセッションとの連携が構成されること |

---

## ✅ 3. セッション状態管理・起動

| 項目         | 内容                                              |
|--------------|---------------------------------------------------|
| 機能名       | セッション状態モニタ                              |
| ユースケース | 各Worktreeが Idle / Busy / Waiting かを把握する   |
| 入力         | `.phantommoon/sessions/*.json`, tmux情報          |
| 出力         | TUI上にステータス表示                             |
| 成功条件     | 状態変化がリアルタイムに反映される                |

---

## ✅ 4. GitHub Issue / PR 連携

| 項目         | 内容                                                            |
|--------------|-----------------------------------------------------------------|
| 機能名       | GitHub同期（Issue・PR）                                        |
| ユースケース | セッションにIssue番号を紐付け、PR作成やマージ状況を表示       |
| 入力         | GitHub Token（事前に `gh auth login` 済み）                    |
| 出力         | PR一覧・ステータス、作成URL、`gh pr create` の起動             |
| 成功条件     | ブラウザでPRが作成・開かれ、紐付けたIssueと一貫性が保たれること |

---

## ✅ 5. 使用ログ収集・トークン課金の記録

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 機能名       | 使用統計ログ（ccusage連携）                                           |
| ユースケース | Claude Codeセッションごとの使用量（token数など）を可視化             |
| 入力         | `logs/*.jsonl`（セッションごとのトークン消費記録）                    |
| 出力         | `.phantommoon/usage/{session}.jsonl`、 `.phantommoon/billing/*.txt` |
| 成功条件     | セッションごとのコストを一覧表示し、合計額の算出も可能               |

---

## ✅ 6. `.phantommoon` ディレクトリ管理

| 項目         | 内容                                               |
|--------------|----------------------------------------------------|
| 機能名       | 設定とメタデータの永続化                          |
| ユースケース | プロジェクトごとのセッション/使用状況を記録・管理 |
| 入力         | セッション操作、TUI操作、ログ出力など              |
| 出力         | `.phantommoon/` 以下に各種ファイル保存              |
| 成功条件     | 設定と状態が永続化され、再起動後も復元されること  |

---

## ✅ 7. CLIサブコマンド対応（非TUI操作）

| 項目         | 内容                                                             |
|--------------|------------------------------------------------------------------|
| 機能名       | CLI操作インターフェース                                          |
| ユースケース | TUIなしで `phanto create` `phanto status` `phanto bill` などを実行 |
| 入力         | サブコマンド・オプション                                         |
| 出力         | stdoutへの出力、TUIと同じ `.phantommoon/` 構成を利用              |
| 成功条件     | TUIと同等の操作がCLIでも可能                                     |

---

## ✅ 8. Export / Report 機能（将来）

| 項目         | 内容                                                    |
|--------------|---------------------------------------------------------|
| 機能名       | 使用量レポートのエクスポート                            |
| ユースケース | プロジェクト単位でCSVやHTMLなどでレポートを出力        |
| 入力         | `.phantommoon/usage/*.jsonl`                            |
| 出力         | `report.csv`, `summary.html` など                       |
| 成功条件     | チームでのコスト共有や請求書作成に役立つフォーマットを提供 |

---

## 📁 想定ディレクトリ構成例

```

project-root/  
├── .phantommoon/  
│ ├── config.json  
│ ├── sessions/  
│ ├── usage/  
│ ├── billing/  
│ └── summary.json  
├── worktrees/  
│ └── {session-name}/

```

---

## 🧠 今後の検討ポイント

- トークン単価のモデル切替（Claude Opus/Sonnet など）
- チーム共有用のメタディレクトリ導入（`.phantommoon.team/` など）
- TUIとCLIの状態整合処理（排他制御やwatch）

